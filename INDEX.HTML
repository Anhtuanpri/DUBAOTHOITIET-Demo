<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Th·ªùi ti·∫øt + B√°o b√£o</title>

<!-- Manifest & iOS meta -->
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#0e0f12">

<!-- Leaflet map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<style>
  :root{
    --bg:#0e0f12; --bg-grad: radial-gradient(900px 600px at 100% 0%, #1b1d22 0%, transparent 60%), radial-gradient(1200px 700px at 0% 100%, #15171c 0%, transparent 65%), #0e0f12;
    --card:#16181d; --line:#22252b; --fg:#e8ecf3; --muted:#9aa4b2; --accent:#76befc; --bar:#ff9f43; --btn:#2a2d34; --shadow:0 18px 60px rgba(0,0,0,.5);
    --red:#ef4444; --orange:#f59e0b; --green:#22c55e; --blue:#3b82f6;
  }
  *{box-sizing:border-box}
  body{margin:0;color:var(--fg);background:var(--bg-grad);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;min-height:100svh;display:flex;align-items:center;justify-content:center;padding:24px}
  .wrap{width:100%; max-width:460px}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{font-weight:800;letter-spacing:.4px}
  .theme{display:flex;gap:8px}
  .btn{border:1px solid var(--line);background:var(--btn);color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.switch{background:transparent}
  .btn.active{outline:2px solid var(--line)}
  .search{display:flex;gap:8px;margin:8px 0 16px}
  .search input{flex:1;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:transparent;color:var(--fg);outline:none}
  .search .go{padding:12px 14px;border:0;border-radius:12px;background:var(--bar);color:#2b1600;font-weight:800;cursor:pointer}
  .phone{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:20px 18px;overflow:hidden}
  .city{letter-spacing:.4px;text-transform:capitalize}
  .dow{color:var(--muted);font-size:12px;margin-top:2px}
  .temp{font-size:72px;font-weight:900;line-height:.95;margin:12px 0 2px}
  .cond{font-size:16px;margin-bottom:2px}
  .greet{color:var(--muted);font-size:13px}
  .stats{display:flex;gap:18px;margin-top:12px;color:var(--muted);font-size:12px}
  .stat .v{color:var(--fg);font-weight:700;font-size:14px}
  .hours{display:flex;gap:10px;overflow-x:auto;padding:14px 2px 8px;margin-top:6px}
  .hour{min-width:78px;text-align:center;border:1px solid var(--line);border-radius:14px;padding:10px;background:transparent}
  .hour .t{color:var(--muted);font-size:12px}
  .hour .v{font-weight:800;font-size:16px;margin:4px 0}
  .hour .p{font-size:12px;color:var(--accent)}
  .days{margin-top:8px;border-top:1px dashed var(--line)}
  .row{display:flex;align-items:center;gap:10px;padding:12px 0;border-bottom:1px dashed var(--line)}
  .row:last-child{border-bottom:0}
  .d{width:58px;color:var(--muted)}
  .icon{width:26px;height:26px}
  .rain{width:52px;text-align:left;color:var(--accent);font-size:12px}
  .temps{display:flex;align-items:center;gap:10px;margin-left:auto;width:56%}
  .tmin,.tmax{width:38px;text-align:center;color:var(--fg)}
  .bar{position:relative;height:6px;border-radius:999px;background:rgba(255,255,255,.08);flex:1}
  .bar .seg{position:absolute;height:100%;background:var(--bar);border-radius:999px;left:0;width:20%}
  footer{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}

  .panel{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .panel h3{margin:4px 0 8px;font-size:16px}
  .hint{color:var(--muted);font-size:12px}
  #map{height:280px;border-radius:12px;overflow:hidden;border:1px solid var(--line);margin-top:8px}
  .legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);margin-top:6px}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .dot.red{background:#ef4444} .dot.orange{background:#f59e0b} .dot.green{background:#22c55e} .dot.me{background:#3b82f6}
  .storm-list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .storm{border:1px dashed var(--line);border-radius:12px;padding:10px}
  .storm.ended{opacity:.65} /* NEW: l√†m m·ªù n·∫øu ƒë√£ tan ‚â§ 3 ng√†y */
  .storm .hd{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .storm .name{font-weight:800}
  .badge{padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid var(--line)}
  .badge.red{background:#3a0a0a;color:#ffb4b4;border-color:#5f1515}
  .badge.orange{background:#3a2a06;color:#ffd88a;border-color:#7a530b}
  .badge.green{background:#052d1a;color:#7de2aa;border-color:#14532d}
  .badge.gray{background:#20232a;color:#cbd5e1;border-color:#364152} /* NEW: badge x√°m cho b√£o ƒë√£ tan */
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;margin-top:6px;color:var(--muted)}
  .kv b{color:var(--fg)}
  .warn{margin-top:6px;padding:8px;border:1px dashed var(--line);border-radius:10px;font-size:12px;line-height:1.45}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">D·ª∞ B√ÅO</div>
      <div class="theme">
        <button class="btn switch" id="lightBtn">Light</button>
        <button class="btn switch active" id="darkBtn">Dark</button>
        <button class="btn" id="installBtn" style="display:none">C√†i ƒë·∫∑t ·ª©ng d·ª•ng</button>
      </div>
    </div>

    <div class="search">
      <input id="q" placeholder="Nh·∫≠p th√†nh ph·ªë‚Ä¶ (VD: H√† N·ªôi, Vinh, ƒê√† N·∫µng)">
      <button class="go" id="btnS">T√¨m</button>
      <button class="btn" id="btnG">GPS</button>
    </div>

    <div class="phone">
      <div class="city" id="place">‚Äî</div>
      <div class="dow" id="dow">‚Äî</div>

      <div class="temp" id="temp">--¬∞</div>
      <div class="cond" id="cond">‚Äî</div>
      <div class="greet" id="greet">‚Äî</div>

      <div class="stats">
        <div class="stat"><div>M·∫∂T TR·ªúI</div><div class="v" id="sun">--:-- / --:--</div></div>
        <div class="stat"><div>GI√ì</div><div class="v" id="wind">-- m/s</div></div>
        <div class="stat"><div>NHI·ªÜT</div><div class="v" id="hiLo">--/--¬∞</div></div>
      </div>

      <div class="hours" id="hours"></div>
      <div class="days" id="days"></div>
    </div>

    <div class="panel">
      <h3>üó∫Ô∏è B·∫£n ƒë·ªì &amp; üåÄ B√£o ƒëang ho·∫°t ƒë·ªông</h3>
      <div class="hint">∆Øu ti√™n b√£o g·∫ßn v·ªã tr√≠ c·ªßa b·∫°n. Nh·∫•n <b>GPS</b> ƒë·ªÉ ƒë·ªãnh v·ªã ch√≠nh x√°c.</div>
      <div id="map"></div>
      <div class="legend"><span class="dot me"></span> V·ªã tr√≠ c·ªßa t√¥i  ¬∑  <span class="dot red"></span> ƒê·ªè  ¬∑  <span class="dot orange"></span> Cam  ¬∑  <span class="dot green"></span> Xanh</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" id="btnStorms">T·∫£i b√£o (GDACS)</button>
        <button class="btn" id="btnAuto">Auto 3h: OFF</button>
      </div>
      <div class="storm-list" id="stormList"></div>
      <div class="hint" id="stormStatus"></div>
    </div>

    <footer>Made By Tu·∫•n Apple - Share Free</footer>
  </div>

<script>
/* --- Icons (SVG) gi·∫£n l∆∞·ª£c --- */
function icnSun(){return `<svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="4"/><path d="M12 2v3M12 19v3M4.2 4.2l2.1 2.1M17.7 17.7l2.1 2.1M2 12h3M19 12h3M4.2 19.8l2.1-2.1M17.7 6.3l2.1-2.1"/></svg>`}
function icnCloud(){return `<svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M7 18h9a4 4 0 0 0 .6-7.96A6 6 0 0 0 6 9a4 4 0 0 0 1 9z"/></svg>`}
function icnRain(){return `<svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M7 17h8a4 4 0 0 0 .6-7.96A6 6 0 0 0 6 8a4 4 0 0 0 1 9z"/><path d="M8 20l1-2M12 21l1-2M16 20l1-2"/></svg>`}
function icnStorm(){return `<svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M7 16h8a4 4 0 0 0 .6-7.96A6 6 0 0 0 6 7a4 4 0 0 0 1 9z"/><path d="M11 22l2-4h-3l2-4"/></svg>`}
function icnSnow(){return `<svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 2v20M4 7l16 10M20 7L4 17"/></svg>`}
function iconFor(code){if([95,96,99].includes(code))return icnStorm();if([61,63,65,80,81,82,51,53,55].includes(code))return icnRain();if([71,73,75,85,86].includes(code))return icnSnow();if([0,1].includes(code))return icnSun();return icnCloud();}
const WMO={0:"Tr·ªùi quang",1:"√çt m√¢y",2:"M√¢y r·∫£i r√°c",3:"Nhi·ªÅu m√¢y",45:"S∆∞∆°ng m√π",48:"S∆∞∆°ng m√π bƒÉng",51:"M∆∞a ph√πn nh·∫π",53:"M∆∞a ph√πn",55:"M∆∞a ph√πn to",61:"M∆∞a nh·∫π",63:"M∆∞a v·ª´a",65:"M∆∞a to",66:"M∆∞a l·∫°nh nh·∫π",67:"M∆∞a l·∫°nh to",71:"Tuy·∫øt nh·∫π",73:"Tuy·∫øt v·ª´a",75:"Tuy·∫øt to",80:"M∆∞a r√†o nh·∫π",81:"M∆∞a r√†o",82:"M∆∞a r√†o to",95:"D√¥ng",96:"D√¥ng c√≥ m∆∞a ƒë√°",99:"D√¥ng ƒë√° to"};
const el=s=>document.querySelector(s), fmtH=t=>new Date(t).toLocaleTimeString([],{hour:'2-digit'}), fmtD=t=>new Date(t).toLocaleDateString('vi-VN',{weekday:'long',day:'2-digit',month:'2-digit'});

/* --- Weather APIs (Open-Meteo) --- */
async function geocode(name){const u=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=vi&format=json`;const r=await fetch(u);const j=await r.json();if(!j.results?.length)throw new Error("Kh√¥ng t√¨m th·∫•y ƒë·ªãa danh");const a=j.results[0];return {lat:a.latitude,lon:a.longitude,label:`${a.name}${a.admin1?", "+a.admin1:""}${a.country?", "+a.country:""}`};}
async function forecast(lat,lon){const p=new URLSearchParams({latitude:lat,longitude:lon,timezone:'auto',current:['temperature_2m','weather_code','wind_speed_10m','is_day'].join(','),hourly:['temperature_2m','precipitation_probability','weather_code'].join(','),daily:['weather_code','temperature_2m_max','temperature_2m_min','sunrise','sunset','precipitation_probability_max'].join(','),forecast_days:10});const r=await fetch(`https://api.open-meteo.com/v1/forecast?${p}`);if(!r.ok)throw new Error("L·ªói d·ªØ li·ªáu");return r.json();}

/* --- Render weather --- */
function renderMain(d,label){el('#place').textContent=label;el('#dow').textContent=fmtD(new Date());el('#temp').textContent=Math.round(d.current.temperature_2m)+'¬∞';el('#cond').textContent=WMO[d.current.weather_code]||('M√£ '+d.current.weather_code);el('#greet').textContent=d.current.is_day?"Ch√∫c m·ªôt ng√†y t·ªët l√†nh":"Ch√∫c bu·ªïi t·ªëi an y√™n";el('#hiLo').textContent=`${Math.round(d.daily.temperature_2m_max[0])}/${Math.round(d.daily.temperature_2m_min[0])}¬∞`;el('#wind').textContent=`${Math.round(d.current.wind_speed_10m)} m/s`;const sr=new Date(d.daily.sunrise[0]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});const ss=new Date(d.daily.sunset[0]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});el('#sun').textContent=`${sr} / ${ss}`;}
function renderHours(d){const h=d.hourly,box=el('#hours');box.innerHTML='';const nowIdx=h.time.findIndex(t=>new Date(t)>=new Date());const take=Array.from({length:12},(_,i)=>nowIdx+i).filter(i=>i<h.time.length);for(const i of take){const div=document.createElement('div');div.className='hour';div.innerHTML=`<div class="t">${fmtH(h.time[i])}</div><div class="v">${Math.round(h.temperature_2m[i])}¬∞</div><div class="p">${h.precipitation_probability?.[i] ?? 0}%</div>`;box.appendChild(div);}}
function renderDays(d){const x=d.daily,box=el('#days');box.innerHTML='';const gMin=Math.min(...x.temperature_2m_min),gMax=Math.max(...x.temperature_2m_max),span=Math.max(1,gMax-gMin);for(let i=0;i<x.time.length;i++){const day=new Date(x.time[i]).toLocaleDateString('vi-VN',{weekday:'short'});const min=Math.round(x.temperature_2m_min[i]),max=Math.round(x.temperature_2m_max[i]);const start=((min-gMin)/span)*100,width=((max-min)/span)*100;const row=document.createElement('div');row.className='row';row.innerHTML=`<div class="d">${i===0?'H√¥m nay':day}</div>${iconFor(x.weather_code[i])}<div class="rain">${Math.round(x.precipitation_probability_max?.[i] ?? 0)}%</div><div class="temps"><div class="tmin">${min}¬∞</div><div class="bar"><div class="seg" style="left:${start}%;width:${Math.max(6,width)}%"></div></div><div class="tmax">${max}¬∞</div></div>`;box.appendChild(row);}}

/* --- App state --- */
let currentRef=null;

/* --- Map (Leaflet) + markers --- */
let map, meMarker, meAccuracy, stormMarkers=[];
function mapInit(){map=L.map('map',{zoomControl:true,attributionControl:false}).setView([21.03,105.85],5);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);}
function mapSetView(lat,lon){map.setView([lat,lon],5);}
function drawMe(lat,lon,acc){if(meMarker)meMarker.remove();if(meAccuracy)meAccuracy.remove();meMarker=L.circleMarker([lat,lon],{radius:6,color:'#1d4ed8',fillColor:'#3b82f6',fillOpacity:.9,weight:2}).addTo(map).bindTooltip("V·ªã tr√≠ c·ªßa t√¥i",{permanent:false});if(acc){meAccuracy=L.circle([lat,lon],{radius:acc,color:'#93c5fd',fillColor:'#93c5fd',fillOpacity:.15,weight:1}).addTo(map);}}
function mapResetStormMarkers(){stormMarkers.forEach(m=>m.remove());stormMarkers=[];}
function addStormMarker(s){
  const color=s.alertlevel==='RED'?'#ef4444':(s.alertlevel==='ORANGE'?'#f59e0b':'#22c55e');
  if(!s.lat||!s.lon)return;
  const mk=L.circleMarker([s.lat,s.lon],{radius:7,color:color,fillColor:color,fillOpacity:.85,weight:2});
  const statusLine = s._life?.state==='ended'
      ? `Tr·∫°ng th√°i: ƒê√É TAN (${s._life.daysAgo} ng√†y tr∆∞·ªõc)`
      : (s._life?.state==='active-until' ? `Tr·∫°ng th√°i: ƒêANG HO·∫†T ƒê·ªòNG (ƒë·∫øn ${s.end})` : 'Tr·∫°ng th√°i: ƒêANG HO·∫†T ƒê·ªòNG');
  mk.addTo(map).bindPopup(`<b>${s.name||s.eventname||'Kh√¥ng t√™n'}</b><br/>${statusLine}<br/>C·∫£nh b√°o: ${s.alertlevel||'‚Äî'}<br/>C·∫≠p nh·∫≠t: ${s.timeStr||'‚Äî'}<br/>Gi√≥ duy tr√¨: ${s.maxwind!=null? s.maxwind+' km/h':'‚Äî'}<br/>Gi√≥ gi·∫≠t: ${s.maxgust!=null? s.maxgust+' km/h':'‚Äî'}`);
  stormMarkers.push(mk);
}

/* --- GPS watch: ch·∫•m xanh + v√≤ng sai s·ªë --- */
let watchId=null;
async function loadByName(name){try{const g=await geocode(name);const d=await forecast(g.lat,g.lon);currentRef={lat:g.lat,lon:g.lon,label:g.label};renderMain(d,g.label);renderHours(d);renderDays(d);mapSetView(g.lat,g.lon);if(storms.length)renderStorms();}catch(e){alert(e.message||e);}}
function loadByGPS(){if(!navigator.geolocation){alert("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ GPS");return;}if(watchId)navigator.geolocation.clearWatch(watchId);watchId=navigator.geolocation.watchPosition(async pos=>{const {latitude:lat,longitude:lon,accuracy}=pos.coords;let label=`(${lat.toFixed(3)}, ${lon.toFixed(3)})`;try{const r=await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=vi&count=1`);const j=await r.json();if(j.results?.[0]){const a=j.results[0];label=`${a.name}${a.admin1? ", "+a.admin1:""}${a.country? ", "+a.country:""}`;}}catch{}const d=await forecast(lat,lon);currentRef={lat,lon,label};renderMain(d,label);renderHours(d);renderDays(d);mapSetView(lat,lon);drawMe(lat,lon,accuracy||0);if(storms.length)renderStorms();},err=>alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: "+err.message),{enableHighAccuracy:true,timeout:15000,maximumAge:0});}

/* --- GDACS: b√£o + gi√≥/gi√≥ gi·∫≠t + c·∫£nh b√°o + TR·∫†NG TH√ÅI/T·ª∞ ·∫®N --- */
let storms=[],autoTimer=null;
function kt2kmh(kts){return Math.round(kts*1.852);}
function guessGust(kmh){return kmh!=null?Math.round(kmh*1.3):null;}
function stormLevel(maxwind){if(maxwind==null)return {name:"Ch∆∞a r√µ",cat:0};if(maxwind<63)return {name:"ATNƒê",cat:0};if(maxwind<119)return {name:"B√£o nhi·ªát ƒë·ªõi (TS)",cat:0};if(maxwind<154)return {name:"Si√™u b√£o C1",cat:1};if(maxwind<178)return {name:"Si√™u b√£o C2",cat:2};if(maxwind<209)return {name:"Si√™u b√£o C3",cat:3};if(maxwind<252)return {name:"Si√™u b√£o C4",cat:4};return {name:"Si√™u b√£o C5",cat:5};}
function hazardAdvice(s){const w=s.maxwind,g=s.maxgust ?? guessGust(w);const L=stormLevel(w);const sea=w>=119?"S√≥ng r·∫•t cao (‚â•6‚Äì10 m), bi·ªÉn ƒë·ªông d·ªØ d·ªôi.":(w>=63?"S√≥ng cao (3‚Äì6 m), bi·ªÉn ƒë·ªông m·∫°nh.":"Bi·ªÉn ƒë·ªông v·ª´a, c·∫ßn theo d√µi.");const rain=s.alertlevel==='RED'?"M∆∞a r·∫•t to, nguy c∆° l≈© qu√©t & s·∫°t l·ªü.":(s.alertlevel==='ORANGE'?"M∆∞a to, ng·∫≠p √∫ng c·ª•c b·ªô.":"M∆∞a r√†o/gi√¥ng c·ª•c b·ªô.");const windLine=(w!=null?`Gi√≥ duy tr√¨ ~${w} km/h`:"Gi√≥ duy tr√¨ ch∆∞a r√µ")+(g!=null?`, gi·∫≠t t·ªõi ~${g} km/h`:"");const onLand="Khuy·∫øn c√°o: tr√°nh v√πng ven bi·ªÉn th·∫•p, neo ƒë·∫≠u t√†u thuy·ªÅn, d·ª± tr·ªØ ƒëi·ªán/n∆∞·ªõc, theo d√µi th√¥ng b√°o ch√≠nh th·ª©c.";return `M·ª©c: ${L.name}. ${windLine}. ${sea} ${rain} ${onLand}`;}

/* NEW: suy lu·∫≠n v√≤ng ƒë·ªùi b√£o + ti√™u ch√≠ ·∫©n */
function parseISODate(d){ if(!d) return null; const t = new Date(d+"T00:00:00Z"); return isNaN(t)?null:t; }
function stormLifecycle(s){
  const now = new Date();
  const ed = parseISODate(s.end);
  if(!ed) return {state:'active', daysAgo:null, hide:false};         // ch∆∞a c√≥ todate
  const diff = Math.floor((now - ed)/86400000);                       // ng√†y t·ª´ l√∫c tan
  if(diff < 0) return {state:'active-until', daysAgo:null, hide:false}; // c√≤n ho·∫°t ƒë·ªông t·ªõi ed
  return {state:'ended', daysAgo:diff, hide: diff > 3};               // ·∫©n n·∫øu ƒë√£ tan > 3 ng√†y
}

async function fetchGDACS_List(days=30){
  const now=new Date();const to=now.toISOString().slice(0,10);
  const past=new Date(now.getTime()-days*86400000).toISOString().slice(0,10);
  const url=`https://www.gdacs.org/gdacsapi/api/events/geteventlist/SEARCH?eventlist=TC&fromdate=${past}&todate=${to}&alertlevel=red;orange;green&format=json`;
  const r=await fetch(url,{headers:{'Accept':'application/json'}});if(!r.ok)throw new Error("GDACS list l·ªói/CORS");
  const j=await r.json();const feats=j.features?j.features:[];
  return feats.map(f=>{
    const p=f.properties||{},g=f.geometry||{};
    let lat=null,lon=null;
    if(g.type==='Point'&&Array.isArray(g.coordinates)){lon=g.coordinates[0];lat=g.coordinates[1];}
    else if(g.type==='MultiPoint'&&Array.isArray(g.coordinates)&&g.coordinates[0]){lon=g.coordinates[0][0];lat=g.coordinates[0][1];}
    let maxwind=p.maxwind_kmh||p.maxwind||null;
    let maxgust=p.maxgust_kmh||p.maxgust||null;
    if(!maxwind&&p.maxwind_kts)maxwind=kt2kmh(p.maxwind_kts);
    if(!maxgust&&p.maxgust_kts)maxgust=kt2kmh(p.maxgust_kts);
    return {eventid:p.eventid,name:p.name||p.eventname||"",alertlevel:(p.alertlevel||"").toUpperCase(),start:p.fromdate?p.fromdate.slice(0,10):null,end:p.todate?p.todate.slice(0,10):null,countries:p.country||p.affectedcountries||p.countrylist||"",gdacsUrl:p.gdacsurl||p.eventurl||"",lat,lon,maxwind,maxgust,timeStr:null,approx:false,_life:null};
  });
}
async function fetchGDACS_Detail(eventid){
  try{
    const url=`https://www.gdacs.org/gdacsapi/api/events/geteventdata?eventtype=TC&eventid=${encodeURIComponent(eventid)}`;
    const r=await fetch(url,{headers:{'Accept':'application/json'}});if(!r.ok)return null;
    const j=await r.json();
    let lat=null,lon=null,maxwind=null,maxgust=null,timeStr=null;
    if(j?.track&&Array.isArray(j.track)&&j.track.length){
      const last=j.track[j.track.length-1];
      lat=last?.lat??null;lon=last?.lon??null;
      if(last?.windspeed_kts)maxwind=kt2kmh(last.windspeed_kts);
      if(last?.gust_kts)maxgust=kt2kmh(last.gust_kts);
      if(last?.timestring)timeStr=last.timestring;
    }
    if(!maxwind&&j?.maxwind_kts)maxwind=kt2kmh(j.maxwind_kts);
    if(!maxgust&&j?.maxgust_kts)maxgust=kt2kmh(j.maxgust_kts);
    return {lat,lon,maxwind,maxgust,timeStr};
  }catch{return null;}
}
async function loadStorms(){
  el('#stormStatus').textContent="ƒêang t·∫£i b√£o t·ª´ GDACS‚Ä¶";
  try{
    const list=await fetchGDACS_List(30);
    const withDetail=await Promise.all(list.map(async s=>{
      const d=await fetchGDACS_Detail(s.eventid);
      if(d){
        s.lat=d.lat??s.lat; s.lon=d.lon??s.lon;
        s.maxwind=s.maxwind??d.maxwind??null;
        s.maxgust=s.maxgust??d.maxgust??null;
        s.timeStr=d.timeStr||s.timeStr;
        s.approx=false;
      }else{
        s.maxgust=s.maxgust ?? guessGust(s.maxwind);
        s.approx=true;
      }
      s._life = stormLifecycle(s);   // NEW: g·∫Øn tr·∫°ng th√°i v√≤ng ƒë·ªùi
      return s;
    }));

    // NEW: ·∫®N b√£o ƒë√£ tan > 3 ng√†y
    storms = withDetail.filter(s => !(s._life && s._life.hide));

    renderStorms();
    el('#stormStatus').textContent=`ƒê√£ n·∫°p ${storms.length} b√£o.`;
    mapResetStormMarkers(); storms.forEach(addStormMarker);
  }catch(e){ console.error(e); el('#stormStatus').textContent="Kh√¥ng t·∫£i ƒë∆∞·ª£c b√£o (c√≥ th·ªÉ CORS b·ªã ch·∫∑n)."; }
}
function distKm(aLat,aLon,bLat,bLon){const R=6371,toRad=d=>d*Math.PI/180;const dLat=toRad(bLat-aLat),dLon=toRad(bLon-aLon);const s1=Math.sin(dLat/2)**2+Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(Math.PI*(dLon/360))**2;return 2*R*Math.asin(Math.sqrt(Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2));}
function renderStorms(){
  const box=el('#stormList');box.innerHTML='';
  if(!storms.length){box.innerHTML=`<div class="hint">Kh√¥ng c√≥ b√£o ƒëang ho·∫°t ƒë·ªông (b√£o ƒë√£ tan > 3 ng√†y s·∫Ω t·ª± ·∫©n).</div>`;return;}
  let arr=storms.slice();
  if(currentRef?.lat&&currentRef?.lon){
    arr.sort((a,b)=>{
      const da=(a.lat&&a.lon)?distKm(currentRef.lat,currentRef.lon,a.lat,a.lon):Infinity;
      const db=(b.lat&&b.lon)?distKm(currentRef.lat,currentRef.lon,b.lat,b.lon):Infinity;
      return da-db;
    });
  }else{
    const rank=l=>l==='RED'?0:(l==='ORANGE'?1:2);
    arr.sort((a,b)=>rank(a.alertlevel)-rank(b.alertlevel));
  }
  arr.forEach(s=>{
    const level=(s.alertlevel||'').toLowerCase();
    const km=a=>a!=null?(a+' km/h'):'‚Äî';
    const approx=s.approx?'‚âà':'';
    const warn=hazardAdvice(s);
    const life=s._life || {state:'active'};
    const stateLabel = life.state==='ended'
        ? `ƒê√É TAN (${life.daysAgo} ng√†y tr∆∞·ªõc)`
        : (life.state==='active-until'
            ? `ƒêANG HO·∫†T ƒê·ªòNG (ƒë·∫øn ${s.end})`
            : 'ƒêANG HO·∫†T ƒê·ªòNG');

    const div=document.createElement('div');
    div.className='storm'+(life.state==='ended'?' ended':'');
    div.innerHTML=`
      <div class="hd">
        <div class="name">${s.name||'Kh√¥ng t√™n'}</div>
        <div class="badge ${life.state==='ended'?'gray':level}">
          ${life.state==='ended'?'ENDED':(s.alertlevel||'‚Äî')}
        </div>
      </div>
      <div class="kv">
        <div><b>Tr·∫°ng th√°i:</b> ${stateLabel}</div>
        <div><b>Khu v·ª±c:</b> ${s.countries||'‚Äî'}</div>
        <div><b>B·∫Øt ƒë·∫ßu:</b> ${s.start||'‚Äî'}</div>
        <div><b>K·∫øt th√∫c (∆∞·ªõc t√≠nh):</b> ${s.end||'‚Äî'}</div>
        <div><b>T√¢m/Lat, Lon:</b> ${s.lat!=null&&s.lon!=null? approx + s.lat.toFixed(2)+", "+s.lon.toFixed(2) : '‚Äî'}</div>
        <div><b>Gi√≥ duy tr√¨:</b> ${km(s.maxwind)}</div>
        <div><b>Gi√≥ gi·∫≠t:</b> ${s.maxgust!=null?((s.timeStr?'':'~')+km(s.maxgust)):'‚Äî'}</div>
      </div>
      ${s.timeStr?`<div class="hint" style="margin-top:4px">C·∫≠p nh·∫≠t track: ${s.timeStr} (UTC)</div>`:''}
      ${s.gdacsUrl?`<div class="hint"><a href="${s.gdacsUrl}" target="_blank">Chi ti·∫øt GDACS</a></div>`:''}
      <div class="warn">‚ö†Ô∏è ${warn}</div>
    `;
    box.appendChild(div);
  });
}

/* --- Install (PWA) button --- */
let deferredPrompt=null;
const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;installBtn.style.display='inline-block';});
installBtn?.addEventListener('click',async()=>{if(!deferredPrompt){alert('iPhone: Safari ‚Üí Share ‚Üí Add to Home Screen');return;}deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.style.display='none';});

/* --- Service Worker --- */
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js');}

/* --- Events & Init --- */
document.getElementById('btnS').onclick=()=>{const q=el('#q').value.trim();if(q)loadByName(q);};
document.getElementById('btnG').onclick=()=> loadByGPS();
document.getElementById('btnStorms').onclick=()=> loadStorms();
document.getElementById('btnAuto').onclick=()=>{const btn=document.getElementById('btnAuto');if(autoTimer){clearInterval(autoTimer);autoTimer=null;btn.textContent='Auto 3h: OFF';}else{loadStorms();autoTimer=setInterval(loadStorms,3*60*60*1000);btn.textContent='Auto 3h: ON';}};
mapInit();
loadByName("H√† N·ªôi");
</script>
</body>
</html>
